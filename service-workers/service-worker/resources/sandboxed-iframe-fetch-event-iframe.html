<script>
let frames = [];
let workers = [];

function with_iframe(url) {
  return new Promise(function(resolve) {
    let frame = document.createElement('iframe');
    frame.src = url;
    frame.onload = function() { resolve(frame); };
    document.body.appendChild(frame);
    frames.push(frame);
  });
}

function with_sandboxed_iframe(url, sandbox) {
  return new Promise(function(resolve) {
    let frame = document.createElement('iframe');
    frame.sandbox = sandbox;
    frame.src = url;
    frame.onload = function() { resolve(frame); };
    document.body.appendChild(frame);
    frames.push(frame);
  });
}

const base_path = `${location.origin}${location.pathname}`;
function fetch_in_worker() {
  return new Promise((resolve) => {
    let blob = new Blob([
      `fetch('${base_path}?test=workerfetch', {mode: 'no-cors'})` +
      "  .then(() => { self.postMessage('OK'); });"]);
    let url = URL.createObjectURL(blob);
    let worker = new Worker(url);
    worker.onmessage = resolve;
    workers.push(worker);
  });
}

function run_test(type) {
  switch (type) {
    case 'fetch':
      return fetch(`${base_path}?test=fetch`, {mode: 'no-cors'});
    case 'workerfetch':
      return fetch_in_worker();
    case 'iframe':
      return with_iframe(`${base_path}?test=iframe`);
    case 'script':
      return with_sandboxed_iframe(`${base_path}?test=script`, "allow-scripts");
    case 'script-origin':
      return with_sandboxed_iframe(`${base_path}?test=script-origin`,
                                   "allow-scripts allow-same-origin");
    case 'cleanup':
      return Promise.resolve().then(() => {
        // Clean up the previous state.
        frames.forEach(f => f.remove());
        workers.forEach(w => w.terminate());
        frames = [];
        workers = [];
      });
    default:
      return Promise.reject(`Unknown type: ${type}`);
  }
}

window.onmessage = event => {
  let id = event.data['id'];
  run_test(event.data['type'])
    .then(() => {
      window.top.postMessage({id: id, result: 'done'}, '*');
    })
    .catch(e => {
      window.top.postMessage({id: id, result: 'error: ' + e.toString()}, '*');
    });
};
</script>
